"use strict";var _async=require("../utils/async");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;const ProxyObj=Object.create(null),StaticPropertyDescriptor=Object.freeze({enumerable:!0,configurable:!0});function addSubscriberToEvent(a,b){let c;c="function"==typeof b?a.pubchan.fnlisteners.get(b):a.pubchan.listeners.get(b),c||(c=new Set,"function"==typeof b?a.pubchan.fnlisteners.set(b,c):a.pubchan.listeners.set(b,c)),c.add(a),a.pathrefs.set(b,c)}function removeSubscriber(a){return a.pathrefs.forEach((b,c)=>{b.delete(a),a.pathrefs.delete(c),b.size||("function"==typeof c?a.pubchan.fnlisteners.delete(c):a.pubchan.listeners.delete(c))})}function handleRefCancellation(a,b){a.callbacks.delete(b),a.callbacks.size||removeSubscriber(a)}function executeCallback(a){if(!a)return;const[b,c]=a;return Array.isArray(b.callback)?b.callback.map(a=>a.call(this,b,c.ids,...c.with)):b.callback.call(this,b,c.ids,...c.with)}function proxiedState(a,b){return new Proxy(ProxyObj,{has(c,d){return!!(a.state&&d in a.state)||Reflect.has(b._state,d)},get(c,d){return a.state&&Reflect.has(a.state,d)?a.state[d]:b._state?b._state[d]:void 0},set(a,c,d){return Reflect.set(b._state,c,d,b._state)},deleteProperty(a,c){return!!(b._state&&c in b._state)&&(delete b._state[c],!0)},ownKeys(){return[...new Set(Reflect.ownKeys(b._state).concat(Reflect.ownKeys(a.state)))]},defineProperty(a,c,d){return Reflect.defineProperty(b._state,c,d)},getOwnPropertyDescriptor(c,d){if(a.state&&a.state[d]||b._state&&b._state[d])return StaticPropertyDescriptor}})}class Subscriber{constructor(a,b){return this.callbacks=new Set,this.pathrefs=new Map,this.pubchan=a,this.async=!0===b.async,this._context=b.context||this,this.callback=executeCallback,this}get length(){return this.callbacks.size}get size(){return this.callbacks.size}get keys(){return Array.from(this.pathrefs.keys())}async(){return(0,_async.asynchronously)(()=>this)}context(a){return this._context=a||this.context,this}to(...a){return a.forEach(a=>Array.isArray(a)?this.to(...a):addSubscriberToEvent(this,a)),this}once(a,b){return this.do(a,b,!0)}do(a,b,c=!1){const d={once:c,state:{},subscription:this,chan:this.pubchan,cancel:()=>handleRefCancellation(this,d),callback:a};return this.callbacks.add(d),b&&(b(d),d._state=d.state),this}cancel(){removeSubscriber(this)}trigger(a,b){this.callbacks.forEach(c=>{c.once&&c.cancel(),a.state?c.state=proxiedState(a,c):c._state&&(c.state=c._state),b.push(this.async?()=>this.callback.call(this._context,[c,a]):this.callback.call(this._context,[c,a]))})}}var _default=Subscriber;exports.default=_default;